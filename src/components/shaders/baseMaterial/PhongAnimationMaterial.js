import * as THREE from 'three';
import BaseAnimationMaterial from "./BaseAnimationMaterial.js"

export default class PhongAnimationMaterial extends BaseAnimationMaterial {

    constructor(parameters, uniformValues) {
        super(parameters);

        var phongShader = THREE.ShaderLib['phong'];

        this.uniforms = THREE.UniformsUtils.merge([phongShader.uniforms, this.uniforms]);
        this.lights = true;
        this.vertexShader = this._concatVertexShader();
        this.fragmentShader = phongShader.fragmentShader;

        // todo add missing default defines
        uniformValues.map && (this.defines['USE_MAP'] = '');
        uniformValues.normalMap && (this.defines['USE_NORMALMAP'] = '');

        this.setUniformValues(uniformValues);
  }

};


PhongAnimationMaterial.prototype._concatVertexShader = function() {
  // based on THREE.ShaderLib.phong
  return [
      "#define PHONG",

      "varying vec3 vViewPosition;",

      "#ifndef FLAT_SHADED",

      "	varying vec3 vNormal;",

      "#endif",

      THREE.ShaderChunk[ "common" ],
      THREE.ShaderChunk[ "uv_pars_vertex" ],
      THREE.ShaderChunk[ "uv2_pars_vertex" ],
      THREE.ShaderChunk[ "displacementmap_pars_vertex" ],
      THREE.ShaderChunk[ "envmap_pars_vertex" ],
      THREE.ShaderChunk[ "lights_phong_pars_vertex" ],
      THREE.ShaderChunk[ "color_pars_vertex" ],
      THREE.ShaderChunk[ "morphtarget_pars_vertex" ],
      THREE.ShaderChunk[ "skinning_pars_vertex" ],
      THREE.ShaderChunk[ "shadowmap_pars_vertex" ],
      THREE.ShaderChunk[ "logdepthbuf_pars_vertex" ],

      this._concatFunctions(),

      this._concatParameters(),

      "void main() {",

      this._concatVertexInit(),

      THREE.ShaderChunk[ "uv_vertex" ],
      THREE.ShaderChunk[ "uv2_vertex" ],
      THREE.ShaderChunk[ "color_vertex" ],
      THREE.ShaderChunk[ "beginnormal_vertex" ],

      this._concatTransformNormal(),

      THREE.ShaderChunk[ "morphnormal_vertex" ],
      THREE.ShaderChunk[ "skinbase_vertex" ],
      THREE.ShaderChunk[ "skinnormal_vertex" ],
      THREE.ShaderChunk[ "defaultnormal_vertex" ],

      "#ifndef FLAT_SHADED", // Normal computed with derivatives when FLAT_SHADED

      "	vNormal = normalize( transformedNormal );",

      "#endif",

      THREE.ShaderChunk[ "begin_vertex" ],

      this._concatTransformPosition(),

      THREE.ShaderChunk[ "displacementmap_vertex" ],
      THREE.ShaderChunk[ "morphtarget_vertex" ],
      THREE.ShaderChunk[ "skinning_vertex" ],
      THREE.ShaderChunk[ "project_vertex" ],
      THREE.ShaderChunk[ "logdepthbuf_vertex" ],

      "	vViewPosition = - mvPosition.xyz;",

      THREE.ShaderChunk[ "worldpos_vertex" ],
      THREE.ShaderChunk[ "envmap_vertex" ],
      THREE.ShaderChunk[ "lights_phong_vertex" ],
      THREE.ShaderChunk[ "shadowmap_vertex" ],

      "}"

  ].join( "\n" );
};

